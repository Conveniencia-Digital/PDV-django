{% load widget_tweaks %}
<div class="modal-header">
    <h5 class="modal-title" id="staticBackdropLabel"> Novo orcamento </h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
<form hx-post="{% url 'cadastrar-orcamento' %}"
      hx-target="#orcamento-Tbody"
      hx-indicator=".htmx-indicator"
      hx-swap="afterbegin">
    {% csrf_token %}
    <div class="modal-body">
        <div class="form-row">
            <div class="col-md-6 mb-1">
                <label class="font-weight-lighter" style="font-size:1.2em">Cliente </label>
            </div>
            <div class="col-md-6 mb-1">
              <label class="font-weight-lighter" style="font-size:1.2em">Aparelho </label>
          </div>
        </div>
        <div class="form-row">
          <div class="col-md-6 mb-3 form-floating">
            {% render_field form.cliente class='form-control'%}
            <label>Selecione o cliente </label>
          </div>
          <div class="col-md-6 mb-3 form-floating">
            {% render_field form.celular class='form-control'%}
            <label >Informe a marca e modelo do celular </label>
          </div>
        </div> 
        <hr>
    <div class="form-row">
      <div class="col-md-6 mb-1 ">
        <h2 class="fw-lighter" style="font-size: 1.5em;">Peças</h2>
      </div>
    </div>
        {{ formset.management_form }}
        <div id="orcamento">
            {% for items_orcamento_form in formset %}
            <div id="item-{{ forloop.counter0 }}" class="form-row">
                {% render_field items_orcamento_form.orcamento class='form-control' data-field='orcamento' %}
                {{ items_orcamento_form.id }}
                <div class="col-md-6 mb-3 form-floating">
                    {% render_field items_orcamento_form.peca class='form-control' hx-get='/peca/preco/' hx-target='#id_preco_orcamento' hx-swap="outerHTML" data-field='peca' %}
                    <label>Selecione a peça </label>
                  </div>
                <div class="col-md-3 mb-3 form-floating">
                    {% render_field items_orcamento_form.preco_orcamento class='form-control' data-field='preco_orcamento' value="0.00" %}
                    <label>Preço Unitario </label>
                </div>
                <div class="col-md-3 mb-3 form-floating">
                    {% render_field items_orcamento_form.quantidade class='form-control' data-field='quantidade' value="01" %}
                    <label>Quantidade</label>
                </div>
                {% endfor %}
            </div>
        </div>
        <button
                id="addItem"
                class="btn btn-primary btn-sm"
                hx-get="{% url 'adicionar-linhas' %}"
                hx-target="#orcamento"
                hx-swap="beforeend settle:1s"
        >Add peca
        </button>
          <hr>
        <label class="font-weight-lighter" style="font-size:1.2em">Serviço</label>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Finalizar</button>
    </div>
</form>
{% block scripts %}
<script>


(function() {
  reorderItems()
})();

document.querySelector('#addItem').addEventListener('click', function() {
  setTimeout(() => {
    reorderItems()
  }, 500)
  
})

function reorderItems() {

  Array.from(document.querySelectorAll("[id^='item-']"))
    .forEach((item, i) => {
      item.setAttribute('id', 'item-' + i)

      if (!item.querySelector('[data-field="orcamento"]')) {
        return
      }

      item.querySelector('[data-field="orcamento"]').setAttribute('name', 'items-' + i + '-orcamento')
      item.querySelector('[data-field="orcamento"]').setAttribute('id', 'id_items-' + i + '-orcamento')

      item.querySelector('[data-field="peca"]').setAttribute('name', 'items-' + i + '-peca')
      item.querySelector('[data-field="peca"]').setAttribute('hx-target', '#id_items-'+ i +'-preco_orcamento')


      item.querySelector('[data-field="quantidade"]').setAttribute('name', 'items-' + i + '-quantidade')

      item.querySelector('[data-field="preco_orcamento"]').setAttribute('name', 'items-' + i + '-preco_orcamento')
      item.querySelector('[data-field="preco_orcamento"]').setAttribute('id', 'id_items-' + i + '-preco_orcamento')

  })

  Array.from(document.querySelectorAll("#id_id"))
    .forEach((item, i) => item.setAttribute('name', 'items-' + (i + 1) + '-id'))

  let totalItems = $('#orcamento').children().length
  document.querySelector('#id_items-TOTAL_FORMS').value = totalItems

  // htmx.org/api/#process
  htmx.process(document.querySelector("#orcamento"))
 
}

  $('form').on('submit', function() {
    $('#staticBackdrop').modal('toggle')
  });

  
  
</script>

{% endblock scripts %}
