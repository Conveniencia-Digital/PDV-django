{% load widget_tweaks %}
<div class="modal-header">
    <h5 class="modal-title" id="staticBackdropLabel"> Novo orcamento </h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
<form hx-post="{% url 'cadastrar-orcamento' %}"
      hx-target="#orcamento-Tbody"
      hx-indicator=".htmx-indicator"
      hx-swap="afterbegin">
    {% csrf_token %}
    <div class="modal-body">
        {% render_field form.cliente class='form-control'%}
        <hr>
        <label class="font-weight-lighter" style="font-size:1.2em">Selecionar Pecas</label>
        {{ formset.management_form }}
        <div id="orcamento">
            {% for items_orcamento_form in formset %}
            <div id="item-{{ forloop.counter0 }}" class="form-row">
                {% render_field items_orcamento_form.orcamento class='form-control' data-field='orcamento' %}
                {{ items_orcamento_form.id }}
                <div class="col-md-6 mb-3">
                    {% render_field items_orcamento_form.peca class='form-control' hx-get='/peca/preco/' data-field='peca' %}
                </div>
                <div class="col-md-3 mb-3">
                    {% render_field items_orcamento_form.preco_orcamento class='form-control' data-field='preco_orcamento' %}
                </div>
                <div class="col-md-3 mb-3">
                    {% render_field items_orcamento_form.quantidade class='form-control' data-field='quantidade' %}
                </div>
                {% endfor %}
            </div>
        </div>
        <button
                id="addItem"
                class="btn btn-primary btn-sm"
                hx-get="{% url 'adicionar-linhas' %}"
                hx-target="#orcamento"
                hx-swap="beforeend"
        >Add peca
        </button>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Finalizar</button>
    </div>
</form>
<script>

(function() {
  reorderItems()
})();

document.querySelector('#addItem').addEventListener('click', function() {
  setTimeout(() => {
    reorderItems()
  }, 500)
})

function reorderItems() {
  Array.from(document.querySelectorAll("[id^='item-']"))
    .forEach((item, i) => {
      item.setAttribute('id', 'item-' + i)


      item.querySelector('[data-field="orcamento"]').setAttribute('name', 'items-' + i + '-orcamento')
      item.querySelector('[data-field="orcamento"]').setAttribute('id', 'id_items-' + i + '-orcamento')

      item.querySelector('[data-field="peca"]').setAttribute('name', 'items-' + i + '-peca')
      item.querySelector('[data-field="preco_orcamento"]').setAttribute('hx-target', '#id_items-'+ i +'-preco_orcamento')


      item.querySelector('[data-field="quantidade"]').setAttribute('name', 'items-' + i + '-quantidade')

      item.querySelector('[data-field="preco_orcamento"]').setAttribute('name', 'items-' + i + '-preco_orcamento')
      item.querySelector('[data-field="preco_orcamento"]').setAttribute('id', 'id_items-' + i + '-preco_orcamento')
  })

  Array.from(document.querySelectorAll("#id_id"))
    .forEach((item, i) => item.setAttribute('name', 'items-' + (i + 1) + '-id'))

  let totalItems = $('#orcamento').children().length
  document.querySelector('#id_items-TOTAL_FORMS').value = totalItems

  // htmx.org/api/#process
  htmx.process(document.querySelector("#orcamento"))
}

  $('form').on('submit', function() {
    $('#staticBackdrop').modal('toggle')
  });

</script>
